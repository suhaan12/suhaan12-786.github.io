<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Players Info & Stats</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    /* Base Styles */
    body {
      font-family: 'Roboto', Arial, sans-serif;
      margin: 20px;
      background-color: #f0f2f5;
      color: #333;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark {
      background-color: #121212;
      color: #e0e0e0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      flex: 1 100%;
      text-align: center;
    }
    /* Navigation Buttons */
    button, a {
      margin: 5px;
      padding: 8px 12px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      border: none;
      outline: none;
      transition: background-color 0.3s;
    }
    button {
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
    }
    button:hover {
      background-color: #45a049;
    }
    a {
      background-color: #008CBA;
      color: white;
    }
    a:hover {
      background-color: #007bb5;
    }
    /* Search Bar */
    .search-container {
      margin: 20px 0;
      text-align: center;
    }
    #search-input {
      width: 80%;
      max-width: 400px;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 1em;
    }
    /* Category and Cards */
    .player-category {
      margin-top: 30px;
    }
    .player-category h2 {
      margin-bottom: 10px;
      border-bottom: 2px solid #ddd;
      padding-bottom: 5px;
    }
    .player-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }
    .player-card {
      position: relative; /* Enable absolutely positioned children */
      background: white;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    body.dark .player-card {
      background: #1e1e1e;
    }
    .player-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    }
    /* Trend indicator arrow */
    .trend-indicator {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 1.4em;
      font-weight: bold;
    }
    .trend-up {
      color: green;
    }
    .trend-down {
      color: red;
    }
    /* Flag icon */
    .flag-icon {
      width: 40px;
      height: auto;
      border-radius: 3px;
      margin-bottom: 8px;
    }
    /* Player title badge */
    .player-title {
      font-size: 0.75em;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .title-gm {
      background-color: #ffcc00;
      color: #000;
    }
    .title-im {
      background-color: #0077b6;
      color: #fff;
    }
    .title-nm {
      background-color: #4caf50;
      color: #fff;
    }
    /* Card Stats */
    .card-stats {
      font-size: 0.8em;
      line-height: 1.4;
      width: 100%;
    }
    .card-stats div {
      margin: 2px 0;
    }
    /* Modal Styles */
    .player-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 600px;
      z-index: 1000;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      animation: modalIn 0.3s ease-out;
    }
    @keyframes modalIn {
      from { opacity: 0; transform: translate(-50%, -45%); }
      to { opacity: 1; transform: translate(-50%, -50%); }
    }
    body.dark .player-modal {
      background: #2d2d2d;
      color: white;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
    }
    .detailed-stats {
      margin-top: 20px;
      font-size: 1em;
    }
    .detailed-stats .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    body.dark .detailed-stats .stat-row {
      border-bottom: 1px solid #555;
    }
    /* Pagination controls */
    #pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px 0;
    }
    #pagination-controls button {
      margin: 0 10px;
    }
    #pagination-info {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Players Info & Stats</h1>
      <div>
        <button id="toggle-dark">Dark Mode</button>
        <a href="index.html">Back to Tracker</a>
      </div>
    </header>
    
    <!-- Search bar -->
    <div class="search-container">
      <input type="text" id="search-input" placeholder="Search player by name...">
    </div>
    
    <!-- Players will be loaded into this section -->
    <div id="players-section"></div>
    
    <!-- Pagination Controls -->
    <div id="pagination-controls"></div>
  </div>
  
  <script>
    let currentPage = 1;
    const cardsPerPage = 30;

    // Helper: Convert flag emoji to ISO country code.
    function emojiToCountryCode(emoji) {
      return [...emoji].map(c => String.fromCharCode(c.codePointAt(0) - 127397)).join('').toLowerCase();
    }
    function getCountryCode(country) {
      if (/^[A-Za-z]{2}$/.test(country)) {
        return country.toLowerCase();
      }
      return emojiToCountryCode(country);
    }

    // Format ratio as a fraction string "X:Y" (or "N/A" if denominator is zero)
    function formatRatio(numerator, denominator) {
      return denominator > 0 ? `${numerator}:${denominator}` : "N/A";
    }

    // Load players from localStorage and populate cards.
    function loadPlayers() {
      const data = JSON.parse(localStorage.getItem('eloData')) || [];
      const section = document.getElementById('players-section');
      const searchQuery = document.getElementById('search-input').value.trim().toLowerCase();

      // Filter players based on search query.
      let filteredData = data.filter(player =>
        player.name.toLowerCase().includes(searchQuery)
      );

      // Sort players by rating descending.
      filteredData.sort((a, b) => b.rating - a.rating);

      // Pagination.
      const totalPages = Math.ceil(filteredData.length / cardsPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const start = (currentPage - 1) * cardsPerPage;
      const playersToShow = filteredData.slice(start, start + cardsPerPage);

      // Create category containers for GM, IM, NM.
      const categories = {
        GM: createCategory('Grandmasters (GM)'),
        IM: createCategory('International Masters (IM)'),
        NM: createCategory('National Masters (NM)')
      };

      // Clear previous category content.
      Object.values(categories).forEach(category => {
        category.querySelector('.player-cards').innerHTML = '';
      });

      // Create cards for players, grouped by title.
      playersToShow.forEach(player => {
        const card = createPlayerCard(player);
        card.addEventListener('click', () => showPlayerModal(player));
        if (categories[player.title]) {
          categories[player.title].querySelector('.player-cards').appendChild(card);
        }
      });

      // Append only non-empty categories.
      section.innerHTML = '';
      Object.values(categories).forEach(category => {
        if (category.querySelector('.player-cards').children.length > 0) {
          section.appendChild(category);
        }
      });

      renderPagination(totalPages);
    }

    function createCategory(title) {
      const container = document.createElement('div');
      container.className = 'player-category';
      container.innerHTML = `
        <h2>${title}</h2>
        <div class="player-cards"></div>
      `;
      return container;
    }

    function createPlayerCard(player) {
      const card = document.createElement('div');
      card.className = 'player-card';

      const countryCode = getCountryCode(player.country);
      
      // Prepare a cleaner summary:
      // - ELO rating
      // - Record: Wins – Draws – Losses
      // - Win percentage
      const winPct = player.gamesPlayed > 0 ? ((player.wins / player.gamesPlayed) * 100).toFixed(1) : "0.0";
      const record = `${player.wins}–${player.draws}–${player.losses}`;
      
      // Check for a recent rating change (delta). We assume that player.delta exists.
      const delta = player.delta || 0;
      let trendHTML = "";
      if (delta > 0) {
        trendHTML = '<div class="trend-indicator trend-up" title="Recent improvement">↑</div>';
      } else if (delta < 0) {
        trendHTML = '<div class="trend-indicator trend-down" title="Recent decline">↓</div>';
      }
      
      card.innerHTML = `
        ${trendHTML}
        <img class="flag-icon" src="https://flagcdn.com/32x24/${countryCode}.png" onerror="this.style.display='none'">
        <h3 style="font-size: 1em; margin: 5px 0;">${player.name}</h3>
        <span class="player-title title-${player.title.toLowerCase()}">${player.title}</span>
        <div class="card-stats">
          <div><strong>ELO:</strong> ${Math.round(player.rating)}</div>
          <div><strong>Record:</strong> ${record}</div>
          <div><strong>Win %:</strong> ${winPct}%</div>
        </div>
      `;
      return card;
    }

    function showPlayerModal(player) {
      const countryCode = getCountryCode(player.country);
      // Compute additional ratios as fractions.
      const winLoss = formatRatio(player.wins, player.losses);
      const drawLoss = formatRatio(player.draws, player.losses);
      const winDraw = formatRatio(player.wins, player.draws);
      const winPct = player.gamesPlayed > 0 ? ((player.wins / player.gamesPlayed) * 100).toFixed(1) : "0.0";
      const record = `${player.wins}–${player.draws}–${player.losses}`;

      const modalHTML = `
        <div class="modal-overlay" onclick="closeModal()"></div>
        <div class="player-modal">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom: 10px;">
            <img class="flag-icon" src="https://flagcdn.com/32x24/${countryCode}.png" alt="${player.country} flag">
            <h2 style="margin:0;">${player.name} (${player.country})</h2>
          </div>
          <div class="player-title title-${player.title.toLowerCase()}" style="margin-bottom: 15px; display:inline-block;">
            ${player.title}
          </div>
          <div class="detailed-stats">
            <div class="stat-row">
              <span><strong>Current Rating:</strong></span>
              <span>${Math.round(player.rating)}</span>
            </div>
            <div class="stat-row">
              <span><strong>Total Games:</strong></span>
              <span>${player.gamesPlayed}</span>
            </div>
            <div class="stat-row">
              <span><strong>Record (W–D–L):</strong></span>
              <span>${record}</span>
            </div>
            <div class="stat-row">
              <span><strong>Win %:</strong></span>
              <span>${winPct}%</span>
            </div>
            <div class="stat-row">
              <span><strong>W:L Ratio:</strong></span>
              <span>${winLoss}</span>
            </div>
            <div class="stat-row">
              <span><strong>D:L Ratio:</strong></span>
              <span>${drawLoss}</span>
            </div>
            <div class="stat-row">
              <span><strong>W:D Ratio:</strong></span>
              <span>${winDraw}</span>
            </div>
          </div>
          <button onclick="closeModal()" style="margin-top: 20px;">Close</button>
        </div>
      `;
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function closeModal() {
      document.querySelector('.modal-overlay')?.remove();
      document.querySelector('.player-modal')?.remove();
    }

    function renderPagination(totalPages) {
      const container = document.getElementById('pagination-controls');
      container.innerHTML = '';
      if (totalPages <= 1) return;

      const prevButton = document.createElement('button');
      prevButton.textContent = 'Previous';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadPlayers();
        }
      });

      const nextButton = document.createElement('button');
      nextButton.textContent = 'Next';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadPlayers();
        }
      });

      const pageInfo = document.createElement('span');
      pageInfo.id = 'pagination-info';
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;

      container.appendChild(prevButton);
      container.appendChild(pageInfo);
      container.appendChild(nextButton);
    }

    // Dark mode toggle.
    document.getElementById('toggle-dark').addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark') ? 'enabled' : 'disabled');
    });

    // Search input event listener.
    document.getElementById('search-input').addEventListener('input', () => {
      currentPage = 1; // Reset to first page on new search.
      loadPlayers();
    });

    // Listen for storage events so that if the tracker updates eloData, we refresh the list.
    window.addEventListener('storage', (event) => {
      if (event.key === 'eloData') {
        loadPlayers();
      }
    });

    // Set dark mode on load if enabled.
    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark');
    }

    // Initial load.
    loadPlayers();
  </script>
</body>
</html>
